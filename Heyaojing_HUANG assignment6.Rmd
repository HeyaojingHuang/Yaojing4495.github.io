---
title: "Heyaojing Huang-Assignment6"
output: html_document
---
Last modified time:
`r format(Sys.Date(), '%B %d, %Y')`

```{r, include = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(censusapi)
library(tidyverse)
library(tigris)
library(sf)
library(leaflet)
library(survey)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r}
# pums_2019_1yr <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*", 
#   regionin = "state:06",
#   vars = c(
#     "SERIALNO",
#     "SPORDER",
#     "PWGTP",
#     "WGTP",
#     "YBL",
#     "BLD",
#     "TEN",
#     "MV",
#     "HINCP",
#     "AGEP"
#   )
# )
```
```{r}
# saveRDS(pums_2019_1yr, "a6_pums.rds")
pums_2019_1yr <- readRDS("a6_pums.rds")
```

```{r}
ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

sf_boundary <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME == "San Francisco")

sf_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[sf_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()
```

```{r}
sf_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>%  
  filter(PUMA %in% sf_pumas$PUMACE10)
```
```{r}
sf_pums_clean <- sf_pums %>%
  mutate(
    YBL = as.numeric(YBL),
    AGEP = as.numeric(AGEP),
    HINCP = as.numeric(HINCP)
  ) %>%
  filter(YBL %in% 1:3) %>%
  arrange(AGEP) %>%
  group_by(SERIALNO)%>%
  summarize_all(first)
```

```{r}
sf_pums_clean_leadrisk <- sf_pums_clean %>%
mutate(
    leadrisk = ifelse(
      (AGEP < 6) &
        (HINCP < 90000),
      1,
      0
    ),
    income = as.numeric(HINCP)
  ) 
```

```{r}
sf_pums_leadrisk_factors <- sf_pums_clean_leadrisk %>% 
  mutate(
    BLD = BLD %>% 
      factor(
        levels = sf_pums_clean_leadrisk$BLD %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    TEN = TEN %>% 
      factor(
        levels = sf_pums_clean_leadrisk$TEN %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    MV = MV %>% 
      factor(
        levels = sf_pums_clean_leadrisk$MV %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    PUMA = PUMA %>% 
      factor(
        levels = sf_pums_clean_leadrisk$PUMA %>% 
          unique() %>%
          sort()
      )
  )
```

#### Create a logit model
##### leadrisk is the predicted variable, and BLD, TEN, MV, and PUMA are the predictors
```{r}
model <- glm(leadrisk ~ BLD + TEN + MV + PUMA,
            family = quasibinomial(),
            sf_pums_leadrisk_factors)

summary(model)
```
#### Make a prediction by using the model
```{r}
sample <- 
  sample_n(sf_pums_leadrisk_factors, 1)
sample
```
```{r}
predict(model, sample, type = "response")
```

As is shown above, if we are given a sample which has a YBL=1, BLD=5, TEN=3,PUMA=07504, by using the model to predict its leadrisk, the probability of having lead risk is 0.01522395. In order to provide a 
specific result(risk or not), we need to determine a threshold, here we use a threshold score=0.1. If the score predicted by the model is less than 0.1, then it will be predicted as "at risk", and vice versa.

```{r}
predict_result <-
  predict(model, sf_pums_leadrisk_factors, type = "response")
```

```{r}
sf_leadrisk <-
  cbind(predict_result,sf_pums_leadrisk_factors)
```

#### Summary of the model
```{r}
summary_2x2 <-
  sf_leadrisk %>% 
  mutate(
    leadrisk_or_not = ifelse(
      leadrisk == 1, 
      "YES, risk", 
      "NO"
    )
  ) %>% 
  pull(leadrisk_or_not) %>% 
  table(predict_result> 0.1)
summary_2x2
```
How many would they mail out based on their threshold score? 
27+4=31

What percentage of postcards do you expect to actually go to low-income households with children? 
4/(27+4)=12.9%

What percentage of all at-risk children are likely to be reached? 
4/(33+4)=10.8%

Ways to improve the strategy:
(Assuming you donâ€™t directly have access to information about incomes and presence of children at the address level.)
We can adjust the threshold score to make the true-positive ratio higher so that a larger proportion of households at risk can receive postcards. This can ensure that the largest proportion of people at risk can be reached.


```{r}
pums_2019_1yr_new <- read_csv("pums_2019_1yr.csv")
```
```{r}
temp <- tempfile()
download.file("https://www2.census.gov/programs-surveys/acs/data/pums/2019/1-Year/csv_hca.zip",destfile = temp)

pums_hca_2019_1yr <- read_csv(unzip(temp,"psam_h06.csv"))

unlink(temp)
```
#### Accounting for replicate weights
```{r}
library(survey)

pums_2019_1yr_wts <-
  sf_pums_leadrisk_factors %>%
  left_join(pums_hca_2019_1yr %>% filter(
    PUMA %in% sf_pumas$PUMACE10
  ),
  by = c("SERIALNO")) %>%
  select(c(paste0("WGTP",1:80)))


```

```{r}
logit_survey_design <- svrepdesign(
  data = sf_pums_leadrisk_factors,
  type = "ACS",
  repweights = pums_2019_1yr_wts,
  weights = ~as.numeric(PWGTP)
)
```

```{r}
logit_survey_model <- svyglm(
  formula = leadrisk ~ BLD + TEN + MV + PUMA,
  family = quasibinomial(),
  design = logit_survey_design
)
```

```{r}
summary(logit_survey_model)
```

```{r}
sample2 <- 
  sample_n(sf_pums_leadrisk_factors, 1)
sample2
```

```{r}
predict(logit_survey_model, sample2, type = "response")
```
```{r}
predict_result2 <-
  predict(logit_survey_model, sf_pums_leadrisk_factors, type = "response")
```

```{r}
sf_leadrisk2 <-
  cbind(predict_result2,sf_pums_leadrisk_factors)
```

```{r}
summary_2x2 <-
  sf_leadrisk2 %>% 
  mutate(
    leadrisk_or_not = ifelse(
      leadrisk == 1, 
      "YES, risk", 
      "NO"
    )
  ) %>% 
  pull(leadrisk_or_not) %>% 
  table(predict_result2> 0.1)
summary_2x2
```

How many would they mail out based on their threshold score? 
106+9=115

What percentage of postcards do you expect to actually go to low-income households with children? 
9/(106+9)=7.8%

What percentage of all at-risk children are likely to be reached? 
9/(28+9)=24.3%